<?xml version="1.0" encoding="UTF-8" ?>
<ReportDataSource><Report reporteId="" reportName="销售毛利报表"/><fieldInfo><field fieldname="Total.BillDate" AsfieldName="BillDate" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="降" display="单据日期" fieldType="5" inputType="0" popUpName="" width="90" classCode="1" linkAdd="" order="1" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据日期"/><Display localStr="en" display="Document date"/><Display localStr="zh_TW" display="單據日期"/></Displays><groupNames/></field><field fieldname="Total.BillDate" AsfieldName="BillDate1" groupByFlag="0" displayFlag="1" condition="&gt;=?" conditionJoin="and" orderbyFlag="" display="单据日期≥" fieldType="5" inputType="0" popUpName="" width="0" classCode="1" linkAdd="" order="2" isStat="0" defaultValue="@MEM:defaultTime" fieldSysType="" fixColName="1" isNull="1" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据日期≥"/><Display localStr="en" display="Period From≥"/><Display localStr="zh_TW" display="單據日期≥"/></Displays><groupNames/></field><field fieldname="Total.BillDate" AsfieldName="BillDate2" groupByFlag="0" displayFlag="1" condition="&lt;=?" conditionJoin="and" orderbyFlag="" display="单据日期≤" fieldType="5" inputType="0" popUpName="" width="0" classCode="1" linkAdd="" order="3" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据日期≤"/><Display localStr="en" display="Period To≤"/><Display localStr="zh_TW" display="單據日期≤"/></Displays><groupNames/></field><field fieldname="Total.BillNo" AsfieldName="BillNo" groupByFlag="0" displayFlag="1" condition="like '%'+?+'%'" conditionJoin="and" orderbyFlag="降" display="单据编号" fieldType="2" inputType="0" popUpName="" width="120" classCode="1" linkAdd="UserFunctionAction.do?tableName=@ValueofDB:BillType&amp;keyId=@ValueofDB:BillID&amp;operation=5" order="4" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据编号"/><Display localStr="en" display="Document No."/><Display localStr="zh_TW" display="單據編號"/></Displays><groupNames/></field><field fieldname="Total.BillType" AsfieldName="BillType" groupByFlag="0" displayFlag="1" condition="=?" conditionJoin="and" orderbyFlag="" display="单据类型" fieldType="2" inputType="1" popUpName="SaleBillType" width="0" classCode="1" linkAdd="" order="5" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据类型"/></Displays><groupNames/></field><field fieldname="''" AsfieldName="DepartmentCode" groupByFlag="0" displayFlag="0" condition="=? or 1=1" conditionJoin="and" orderbyFlag="" display="部门" fieldType="2" inputType="2" popUpName="ReportSelectDepartment_v2" width="0" classCode="1" linkAdd="" order="6" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_TW" display="部門"/><Display localStr="zh_CN" display="部门"/><Display localStr="en" display="department"/></Displays><groupNames/></field><field fieldname="tblCompany.classCode" AsfieldName="CompanyCode" groupByFlag="0" displayFlag="0" condition="=? or 1=1" conditionJoin="and" orderbyFlag="" display="客户" fieldType="2" inputType="2" popUpName="ReportSelectClient_v2" width="0" classCode="1" linkAdd="" order="7" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="Customer" analysis="0"><Displays><Display localStr="zh_TW" display="客戶"/><Display localStr="zh_CN" display="客户"/><Display localStr="en" display="Customer"/></Displays><groupNames/></field><field fieldname="''" AsfieldName="EmployeeID" groupByFlag="0" displayFlag="0" condition="=? or 1=1" conditionJoin="and" orderbyFlag="" display="经手人" fieldType="2" inputType="2" popUpName="ReportSelectEmployee_v2" width="0" classCode="1" linkAdd="" order="8" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_TW" display="經手人"/><Display localStr="zh_CN" display="经手人"/><Display localStr="en" display="Responsible person"/></Displays><groupNames/></field><field fieldname="Total.BillName" AsfieldName="BillName" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="单据类型" fieldType="2" inputType="0" popUpName="" width="80" classCode="1" linkAdd="" order="9" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据类型"/><Display localStr="en" display="Document type"/><Display localStr="zh_TW" display="單據類型"/></Displays><groupNames/></field><field fieldname="tblCompany.[tblCompany_2]" AsfieldName="ComFullName" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="客户" fieldType="2" inputType="0" popUpName="" width="200" classCode="1" linkAdd="" order="10" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="Supplier" analysis="0"><Displays><Display localStr="zh_CN" display="客户"/><Display localStr="en" display="Customer"/><Display localStr="zh_TW" display="客户"/></Displays><groupNames/></field><field fieldname="tblDepartMent.DeptFullName" AsfieldName="department" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="部门" fieldType="2" inputType="0" popUpName="" width="75" classCode="1" linkAdd="" order="11" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="部门"/><Display localStr="en" display="Department"/><Display localStr="zh_TW" display="部門"/></Displays><groupNames/></field><field fieldname="tblEmployee.EmpFullName" AsfieldName="employee" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="经手人" fieldType="2" inputType="0" popUpName="" width="65" classCode="1" linkAdd="" order="12" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="经手人"/><Display localStr="en" display="Handler"/><Display localStr="zh_TW" display="經手人"/></Displays><groupNames/></field><field fieldname="Total.TotalTaxAmount" AsfieldName="TotalTaxAmount" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="单据金额" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="13" isStat="1" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="单据金额"/><Display localStr="en" display="tax amount"/><Display localStr="zh_TW" display="含税金额"/></Displays><groupNames/></field><field fieldname="Total.SaleTax" AsfieldName="SaleTax" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="销项税" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="14" isStat="1" defaultValue="" fieldSysType="BillTax" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="销项税"/><Display localStr="en" display="tax amount"/><Display localStr="zh_TW" display="含税金额"/></Displays><groupNames/></field><field fieldname="Total.PreferAmount" AsfieldName="PreferAmount" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="优惠金额" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="15" isStat="1" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="优惠金额"/><Display localStr="en" display="Preferential amount"/><Display localStr="zh_TW" display="優惠金額"/></Displays><groupNames/></field><field fieldname="Total.ChangeAmt" AsfieldName="ChangeAmt" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="调价金额" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="16" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_TW" display="調價金額"/><Display localStr="zh_CN" display="调价金额"/><Display localStr="en" display="Adjusted amount"/></Displays><groupNames/></field><field fieldname="Total.AfterChangeAmt-Total.SaleTax" AsfieldName="AfterChangeAmt" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="调后金额" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="17" isStat="1" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="调后金额"/><Display localStr="en" display="AfterChangeAmt"/><Display localStr="zh_TW" display="調后金額"/></Displays><groupNames/></field><field fieldname="Total.CostAmount" AsfieldName="CostAmount" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="成本金额" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="18" isStat="1" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="AmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="成本金额"/><Display localStr="en" display="Cost amount"/><Display localStr="zh_TW" display="成本金額"/></Displays><groupNames/></field><field fieldname="Total.GrossProfit-Total.SaleTax" AsfieldName="GrossProfit" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="毛利" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="19" isStat="1" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="1" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="AmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="毛利"/><Display localStr="en" display="Gross profit"/><Display localStr="zh_TW" display="毛利"/></Displays><groupNames/></field><field fieldname="Total.GrossProfitPer*100" AsfieldName="GrossProfitPer" groupByFlag="0" displayFlag="1" condition="" conditionJoin="  " orderbyFlag="" display="毛利率(%)" fieldType="1" inputType="0" popUpName="" width="100" classCode="1" linkAdd="" order="20" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="AmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="毛利率(%)"/><Display localStr="en" display="Gross profit rate(%)"/><Display localStr="zh_TW" display="毛利率(%)"/></Displays><groupNames/></field><field fieldname="Total.BillID" AsfieldName="BillID" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="单据ID" fieldType="2" inputType="0" popUpName="" width="0" classCode="1" linkAdd="" order="21" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="单据ID"/></Displays><groupNames/></field><field fieldname="Total.CompanyCode" AsfieldName="CompanyCodeA" groupByFlag="0" displayFlag="1" condition="= ?" conditionJoin="and" orderbyFlag="" display="往来单位" fieldType="2" inputType="3" popUpName="" width="0" classCode="1" linkAdd="" order="22" isStat="0" defaultValue="" fieldSysType="" fixColName="0" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_TW" display="往來單位"/><Display localStr="zh_CN" display="往来单位"/><Display localStr="en" display="Related company"/></Displays><groupNames/></field><field fieldname="Total.HaveRecv" AsfieldName="HaveRecv" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="已收款" fieldType="1" inputType="0" popUpName="" width="80" classCode="1" linkAdd="" order="23" isStat="1" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="已收款"/></Displays><groupNames/></field><field fieldname="Total.NotRecv" AsfieldName="NotRecv" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="未收款" fieldType="1" inputType="0" popUpName="" width="80" classCode="1" linkAdd="" order="24" isStat="1" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="SAmountIdentifier" analysis="0"><Displays><Display localStr="zh_CN" display="未收款"/></Displays><groupNames/></field><field fieldname="Total.OverDate" AsfieldName="OverDate" groupByFlag="0" displayFlag="1" condition="" conditionJoin="" orderbyFlag="" display="超期" fieldType="2" inputType="0" popUpName="" width="60" classCode="1" linkAdd="" order="25" isStat="0" defaultValue="" fieldSysType="" fixColName="1" isNull="0" planarField="0" subSQL="" repeatNotShow="0" zeroDisplay="0" seriesCol="" seriesNums="" crossField="" groupName="" fieldIdentity="" analysis="0"><Displays><Display localStr="zh_CN" display="超期"/></Displays><groupNames/></field></fieldInfo><SQL text="select vbCrLf    Total.BillDate as BillDate,vbCrLf    Total.BillDate as BillDate1,vbCrLf    Total.BillDate as BillDate2,vbCrLf    Total.BillNo as BillNo,vbCrLf    Total.BillType as BillType,vbCrLf    Total.BillName as BillName,vbCrLf    tblCompany.[tblCompany_2] as ComFullName,vbCrLf    tblDepartMent.DeptFullName as department,vbCrLf    tblEmployee.EmpFullName as employee,vbCrLf    Total.TotalTaxAmount as TotalTaxAmount,vbCrLf    Total.SaleTax as SaleTax,vbCrLf    Total.PreferAmount as PreferAmount,vbCrLf    Total.ChangeAmt as ChangeAmt,vbCrLf    Total.AfterChangeAmt-Total.SaleTax as AfterChangeAmt,vbCrLf    Total.CostAmount as CostAmount,vbCrLf    Total.GrossProfit-Total.SaleTax as GrossProfit,vbCrLf    Total.GrossProfitPer*100 as GrossProfitPer,vbCrLf    Total.BillID as BillID,vbCrLf    Total.CompanyCode as CompanyCodeA,vbCrLf    Total.HaveRecv as HaveRecv,vbCrLf    Total.NotRecv as NotRecv,vbCrLf    Total.OverDate as OverDatevbCrLffrom(select max(tblSalesOutStock.TotalAlrAccAmt) as HaveRecv, (case when max(tblSalesOutStock.NeedReturnAmt)&lt;0 then 0 else max(tblSalesOutStock.NeedReturnAmt) end) as NotRecv,(case when max(tblSalesOutStock.NeedReturnAmt)&gt;0 and getdate()&gt;max(tblSalesOutStock.AcceptDate) and len(max(tblSalesOutStock.AcceptDate))!=0 then '是' else '否' end) as OverDate,tblSalesOutStock.id as BillID,tblSalesOutStock.BillDate,tblSalesOutStock.BillNo,'销售出库单' as BillName,'tblSalesOutStock' as BillType,tblSalesOutStock.CompanyCode,tblSalesOutStock.DepartmentCode,tblSalesOutStock.EmployeeID,SUM(b.Amount) as TotalAmount,SUM(b.TaxAmount) as TotalTaxAmount,sum(b.PreferAmount) as PreferAmount,SUM(b.AfterChangeAmt-b.PreferBackAmount) as ChangeAmt,sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)) as SaleTax,SUM(b.AfterChangeAmt) as AfterChangeAmt,sum(b.CostAmount) as CostAmount,SUM(b.AfterChangeAmt-b.CostAmount) as GrossProfit,case sum(b.AfterChangeAmt) when 0 then 0 else (SUM(b.AfterChangeAmt-b.CostAmount)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)))/(SUM(b.AfterChangeAmt)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end))) end as GrossProfitPer from tblSalesOutStock join tblSalesOutStockDet b on tblSalesOutStock.id=b.f_ref where tblSalesOutStock.workFlowNodeName='finish' and tblSalesOutStock.Billdate&gt;=@condition:BillDate1 and tblSalesOutStock.Billdate&lt;=(case when len(@condition:BillDate2)=0 then '9999-12-31' else @condition:BillDate2 end) @condsent_DepartmentCode:[and tblSalesOutStock.DepartmentCode=@condition:DepartmentCode] @condsent_CompanyCode:[and tblSalesOutStock.CompanyCode=@condition:CompanyCode] @condsent_EmployeeID:[and tblSalesOutStock.EmployeeID=@condition:EmployeeID] @condsent_BillNo:[and tblSalesOutStock.BillNo like '%'+@condition:BillNo+'%'] @condsent_BillType:[and 'tblSalesOutStock'=@condition:BillType]vbCrLf group by  tblSalesOutStock.BillDate,tblSalesOutStock.BillNo,tblSalesOutStock.CompanyCode,tblSalesOutStock.DepartmentCode,tblSalesOutStock.EmployeeID,tblSalesOutStock.idvbCrLfvbCrLfunion all  select -max(tblSalesReturnStock.AlreadyPayAmt) as HaveRecv, -(case when max(tblSalesReturnStock.NeedPayAmt)&lt;0 then 0 else max(tblSalesReturnStock.NeedPayAmt) end) as NotRecv,'' as OverDate,tblSalesReturnStock.id as BillID,tblSalesReturnStock.BillDate,tblSalesReturnStock.BillNo,'销售退货单' as BillName,'tblSalesReturnStock' as BillType,tblSalesReturnStock.CompanyCode,tblSalesReturnStock.DepartmentCode,tblSalesReturnStock.EmployeeID,-1*sum(b.Amount) as TotalAmount,-1*SUM(b.TaxAmount) as TotalTaxAmount,0 as PreferAmount,0 as ChangeAmt,-1*sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)) as SaleTax,-1*SUM(b.TaxAmount) as AfterChangeAmt,-1*sum(b.CostAmount) as CostAmount,-1*SUM(b.TaxAmount-isnull(b.CostAmount,0)) as GrossProfit,case when SUM(b.TaxAmount)=0 then 0 else (SUM(b.TaxAmount-isnull(b.CostAmount,0))-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)))/(SUM(b.TaxAmount)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end))) end as GrossProfitPer  from tblSalesReturnStock  join tblSalesReturnStockDet b on tblSalesReturnStock.id=b.f_ref  where tblSalesReturnStock.workFlowNodeName='finish' and tblSalesReturnStock.Billdate&gt;=@condition:BillDate1 and tblSalesReturnStock.Billdate&lt;=(case when len(@condition:BillDate2)=0 then '9999-12-31' else @condition:BillDate2 end) @condsent_DepartmentCode:[and tblSalesReturnStock.DepartmentCode=@condition:DepartmentCode] @condsent_CompanyCode:[and tblSalesReturnStock.CompanyCode=@condition:CompanyCode] @condsent_EmployeeID:[and tblSalesReturnStock.EmployeeID=@condition:EmployeeID] @condsent_BillNo:[and tblSalesReturnStock.BillNo like '%'+@condition:BillNo+'%'] @condsent_BillType:[and 'tblSalesReturnStock'=@condition:BillType]vbCrLfgroup by tblSalesReturnStock.BillDate,tblSalesReturnStock.BillNo,tblSalesReturnStock.CompanyCode,tblSalesReturnStock.DepartmentCode,tblSalesReturnStock.EmployeeID,tblSalesReturnStock.idvbCrLfunion all vbCrLfselect max(tblSalesReplace.TotalAlrAccAmt) as HaveRecv, (case when max(tblSalesReplace.NeedReturnAmt)&lt;0 then 0 else max(tblSalesReplace.NeedReturnAmt) end) as NotRecv,'' as OverDate,tblSalesReplace.id as BillID,tblSalesReplace.BillDate,tblSalesReplace.BillNo,'销售换货单' as BillName,'tblSalesReplace' as BillType,tblSalesReplace.CompanyCode,tblSalesReplace.DepartmentCode,tblSalesReplace.EmployeeID,-1*sum(b.Amount) as TotalAmount,-1*SUM(b.TaxAmount) as TotalTaxAmount,0 as PreferAmount,0 as ChangeAmt,-1*sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)) as SaleTax,-1*SUM(b.TaxAmount) as AfterChangeAmt,-1*sum(b.CostAmount) as CostAmount,-1*SUM(b.TaxAmount-b.CostAmount) as GrossProfit,case when SUM(b.TaxAmount)=0 then 0 else (SUM(b.TaxAmount-b.CostAmount)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)))/(SUM(b.TaxAmount)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end))) end as GrossProfitPer from tblSalesReplace join tblSalesReplaceDet b on tblSalesReplace.id=b.f_ref where tblSalesReplace.workFlowNodeName='finish' and tblSalesReplace.Billdate&gt;=@condition:BillDate1 and tblSalesReplace.Billdate&lt;=(case when len(@condition:BillDate2)=0 then '9999-12-31' else @condition:BillDate2 end) @condsent_DepartmentCode:[and tblSalesReplace.DepartmentCode=@condition:DepartmentCode] @condsent_CompanyCode:[and tblSalesReplace.CompanyCode=@condition:CompanyCode] @condsent_EmployeeID:[and tblSalesReplace.EmployeeID=@condition:EmployeeID] @condsent_BillNo:[and tblSalesReplace.BillNo like '%'+@condition:BillNo+'%'] @condsent_BillType:[and 'tblSalesReplace'=@condition:BillType]vbCrLfgroup by  tblSalesReplace.BillDate,tblSalesReplace.BillNo,tblSalesReplace.CompanyCode,tblSalesReplace.DepartmentCode,tblSalesReplace.EmployeeID,tblSalesReplace.idvbCrLfunion all vbCrLfselect '0' as HaveRecv, '0' as NotRecv,'' as OverDate,tblSalesReplace.id as BillID,tblSalesReplace.BillDate,tblSalesReplace.BillNo,'销售换货单' as BillName,'tblSalesReplace' as BillType,tblSalesReplace.CompanyCode,tblSalesReplace.DepartmentCode,tblSalesReplace.EmployeeID,sum(b.Amount) as TotalAmount,SUM(b.TaxAmount) as TotalTaxAmount,sum((case when c.TotalTaxAmount=0 then 0 else (tblSalesReplace.DiscountAmount/c.TotalTaxAmount*b.TaxAmount) end)) as PreferAmount,0 as ChangeAmt,sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)) as SaleTax,SUM(b.TaxAmount-(case when c.TotalTaxAmount=0 then 0 else (tblSalesReplace.DiscountAmount/c.TotalTaxAmount*b.TaxAmount) end)) as AfterChangeAmt,sum(b.CostAmount) as CostAmount,SUM(b.TaxAmount-(case when c.TotalTaxAmount=0 then 0 else (tblSalesReplace.DiscountAmount/c.TotalTaxAmount*b.TaxAmount) end)-b.CostAmount) as GrossProfit,case when SUM(b.TaxAmount)=0 then 0 else (SUM(b.TaxAmount-b.CostAmount)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end)))/(SUM(b.TaxAmount)-sum((case when InVoiceType=2 then b.CoTaxAmt else 0 end))) end as GrossProfitPer from tblSalesReplace join (select f_ref,sum(TaxAmount) as TotalTaxAmount from tblSalesReplaceDetail group by f_ref) as c on tblSalesReplace.id=c.f_ref join tblSalesReplaceDetail b on tblSalesReplace.id=b.f_ref where tblSalesReplace.workFlowNodeName='finish' and tblSalesReplace.Billdate&gt;=@condition:BillDate1 and tblSalesReplace.Billdate&lt;=(case when len(@condition:BillDate2)=0 then '9999-12-31' else @condition:BillDate2 end) @condsent_DepartmentCode:[and tblSalesReplace.DepartmentCode=@condition:DepartmentCode] @condsent_CompanyCode:[and tblSalesReplace.CompanyCode=@condition:CompanyCode] @condsent_EmployeeID:[and tblSalesReplace.EmployeeID=@condition:EmployeeID] @condsent_BillNo:[and tblSalesReplace.BillNo like '%'+@condition:BillNo+'%'] @condsent_BillType:[and 'tblSalesReplace'=@condition:BillType]vbCrLf group by  tblSalesReplace.BillDate,tblSalesReplace.BillNo,tblSalesReplace.CompanyCode,tblSalesReplace.DepartmentCode,tblSalesReplace.EmployeeID,tblSalesReplace.id)TotalvbCrLf join tblCompany on Total.CompanyCode=tblCompany.classCodevbCrLf left join tblDepartment on Total.DepartmentCode=tblDepartment.classCodevbCrLf left join tblEmployee on Total.EmployeeID=tblEmployee.idvbCrLfwhere 1=1 vbCrLf      and (Total.BillDate &gt;=?)vbCrLf      and (Total.BillDate &lt;=?)vbCrLf      and (Total.BillNo like '%'+?+'%')vbCrLf      and (Total.BillType =?)vbCrLf      and ('' =? or 1=1)vbCrLf      and (tblCompany.classCode =? or 1=1)vbCrLf      and ('' =? or 1=1)vbCrLf      and (Total.CompanyCode = ?)vbCrLfvbCrLforder by vbCrLf   Total.BillDate desc,vbCrLf   Total.BillNo descvbCrLfvbCrLf"/><charts/></ReportDataSource>
